// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

generator kysely {
  provider     = "prisma-kysely"
  output       = "../database//kysely/"
  fileName     = "types.ts"
  enumFileName = "enums.ts"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model emailVerificationCode {
  id        String   @id
  code      String
  userId    String
  email     String
  expiresAt DateTime
  User      User     @relation(fields: [userId], references: [id])
}

enum Role {
  USER
  ADMIN
  MODERATOR
  SELLER
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  sessions      Session[]
  emailVerified Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?

  PasswordResetToken    PasswordResetToken[]
  CodeRepo              CodeRepo[]
  emailVerificationCode emailVerificationCode[]
  orders                Order[]

  bannedUntil DateTime?

  role Role @default(USER)

  sellerProfile SellerProfile?
  profile       Profile?

  Review         Review[]
  Comment        Comment[]
  SearchHistory  SearchHistory[]
  SalesAggregate SalesAggregate[]
}

model Profile {
  id          String  @id @default(cuid())
  profileImg  String?
  name        String?
  phoneNumber String?
  user        User    @relation(fields: [userId], references: [id])
  userId      String  @unique
}

model SellerProfile {
  id                 String                   @id @default(cuid())
  user               User                     @relation(fields: [userId], references: [id])
  userId             String                   @unique
  profileImg         String?
  businessName       String
  businessAddress    String
  businessPhone      String
  businessEmail      String
  identityDoc        String?
  verificationDate   DateTime?
  verificationStatus SellerVerificationStatus @default(PENDING)
  bankAccount        BankAccount?
  Payout             Payout[]
  balance            Float                    @default(0)
  PayoutRequest      PayoutRequest[]
  lastPayoutDate     DateTime?                // New field
}

enum SellerVerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

model BankAccount {
  id                String        @id @default(cuid())
  sellerProfile     SellerProfile @relation(fields: [sellerProfileId], references: [id])
  sellerProfileId   String        @unique
  accountHolderName String
  accountNumber     String
  bankName          String
  swiftCode         String
  iban              String?
  routingNumber     String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
}

model PayoutRequest {
  id              String              @id @default(cuid())
  sellerProfile   SellerProfile       @relation(fields: [sellerProfileId], references: [id])
  sellerProfileId String
  totalAmount     Float               // Updated field
  status          PayoutRequestStatus @default(PENDING)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  processedAt     DateTime?
  payout          Payout?
  lastPayoutDate  DateTime?           // New field
  orders          Order[]             // New relation
}

enum PayoutRequestStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSED
}

model Payout {
  id              String        @id @default(cuid())
  sellerProfile   SellerProfile @relation(fields: [sellerProfileId], references: [id])
  sellerProfileId String
  payoutRequest   PayoutRequest @relation(fields: [payoutRequestId], references: [id])
  payoutRequestId String        @unique
  totalAmount     Float         // Updated field
  currency        String
  status          PayoutStatus  @default(PENDING)
  stripePayoutId  String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model Session {
  id        String   @id
  userId    String
  expiresAt DateTime
  user      User     @relation(references: [id], fields: [userId], onDelete: Cascade)
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  tokenHash String   @unique
  userId    String
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id])
}

model CodeRepo {
  id          String         @id @default(cuid())
  userId      String
  user        User           @relation(fields: [userId], references: [id])
  sourceJs    String         @db.Text
  sourceCss   String         @db.Text
  reviews     Review[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  deletedAt   DateTime?
  visibility  Visibility     @default(public)
  status      CodeRepoStatus @default(pending)
  name        String
  description String?
  language    Language
  price       Float          @default(0.0)
  tags        Tag[]
  codeChecks  CodeCheck[]
  orders      Order[]
}

enum CodeRepoStatus {
  pending
  active
  rejected
  bannedUser
}

enum Visibility {
  public
  private
}

enum Language {
  JSX
  TSX
}

model Tag {
  id        String    @id @default(cuid())
  name      String    @unique
  repoId    String
  codeRepo  CodeRepo  @relation(fields: [repoId], references: [id])
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model SearchHistory {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  tag       String
  createdAt DateTime @default(now())
}

model CodeCheck {
  id                        String   @id @default(cuid())
  repoId                    String
  securityScore             Int
  maintainabilityScore      Int
  readabilityScore          Int
  securitySuggestion        String   @db.Text
  maintainabilitySuggestion String   @db.Text
  readabilitySuggestion     String   @db.Text
  overallDescription        String   @db.Text
  eslintErrorCount          Int
  eslintFatalErrorCount     Int
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  Repo                      CodeRepo @relation(fields: [repoId], references: [id])
}

model Order {
  id                    String         @id @default(cuid())
  userId                String
  user                  User           @relation(fields: [userId], references: [id])
  codeRepoId            String
  codeRepo              CodeRepo       @relation(fields: [codeRepoId], references: [id])
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  deletedAt             DateTime?
  status                OrderStatus    @default(REQUIRESPAYMENTMETHOD)
  totalAmount           Float
  stripePaymentIntentId String?
  stripePaymentMethodId String?
  payoutRequest         PayoutRequest? @relation(fields: [payoutRequestId], references: [id])
  payoutRequestId       String?        // New field
}

enum OrderStatus {
  REQUIRESPAYMENTMETHOD
  REQUIRESCONFIRMATION
  REQUIRESACTION
  PROCESSING
  REQUIRESCAPTURE
  CANCELLED
  SUCCEEDED
}

model SalesAggregate {
  id         String   @id @default(cuid())
  sellerId   String
  seller     User     @relation(fields: [sellerId], references: [id])
  date       DateTime
  revenue    Float
  salesCount Int

  @@unique([sellerId, date])
}

enum ReviewFlag {
  NONE
  SPAM
  INAPPROPRIATE_LANGUAGE
  HARASSMENT
  OFF_TOPIC
  FALSE_INFORMATION
  OTHER
}
model Review {
  id        String    @id @default(cuid())
  content   String
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  repoId    String
  repo      CodeRepo  @relation(fields: [repoId], references: [id])
  rating    Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  comments  Comment[]
  flag     ReviewFlag @default(NONE)
  upvotes   Int       @default(0)
  downvotes Int       @default(0)
}

model Comment {
  id        String    @id @default(cuid())
  content   String
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  reviewId  String
  review    Review    @relation(fields: [reviewId], references: [id])
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  flag      Int?      @default(0)
  upvotes   Int       @default(0)
  downvotes Int       @default(0)
}

model SupportTicket {
  id        String              @id @default(cuid())
  email     String
  title     String
  content   String
  status    SupportTicketStatus @default(todo)
  type      SupportTicketType   @default(general)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
}

enum SupportTicketStatus {
  inProgress
  todo
  backlog
  done
}

enum SupportTicketType {
  general
  technical
  payment
}

model Media {
  id        String   @id @default(cuid())
  url       String
  type      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
